<!DOCTYPE html>
<html>
	<head>
		<title>Admin Panel</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				padding: 20px;
				background-color: #f5f5f5;
			}
			h2 {
				color: #007bff;
				text-align: center;
			}
			.request {
				border: 1px solid #ccc;
				padding: 15px;
				margin-top: 10px;
				border-radius: 8px;
				background-color: white;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			.buttons {
				margin-top: 10px;
			}
			button {
				margin-right: 10px;
				padding: 8px 16px;
				border: none;
				border-radius: 4px;
				color: #fff;
				background-color: #007bff;
				cursor: pointer;
				font-weight: bold;
			}
			button:hover {
				opacity: 0.8;
			}
			button.reject {
				background-color: #dc3545;
			}
			button.stop {
				background-color: #6c757d;
			}
			.audio-controls {
				background-color: white;
				padding: 20px;
				border-radius: 8px;
				margin-bottom: 20px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			.audio-controls h3 {
				margin-top: 0;
				color: #333;
			}
			.volume-control {
				margin: 10px 0;
			}
			.volume-control label {
				display: block;
				margin-bottom: 5px;
				font-weight: bold;
			}
			.volume-slider {
				width: 100%;
				margin-bottom: 10px;
			}
			.status {
				padding: 10px;
				border-radius: 4px;
				margin-top: 10px;
				font-weight: bold;
			}
			.status.connected {
				background-color: #d4edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			}
			.status.disconnected {
				background-color: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			}
			.status.playing {
				background-color: #cce5ff;
				color: #004085;
				border: 1px solid #99ccff;
			}
			.talking-indicator {
				color: #28a745;
				font-weight: bold;
			}
		</style>
	</head>
	<body>
		<h2>üéôÔ∏è Conference Admin Panel</h2>

		<div class="audio-controls">
			<h3>Audio Controls</h3>
			<div class="volume-control">
				<label for="volumeSlider"
					>Volume: <span id="volumeValue">80%</span></label
				>
				<input
					type="range"
					id="volumeSlider"
					class="volume-slider"
					min="0"
					max="100"
					value="80"
				/>
			</div>
			<div id="connectionStatus" class="status disconnected">Connecting...</div>
			<div id="audioStatus" class="status">No audio streaming</div>
		</div>

		<div id="requests"></div>

		<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
		<script>
			const socket = io("http://145.223.98.156:3000");

			const requestsDiv = document.getElementById("requests");
			const connectionStatus = document.getElementById("connectionStatus");
			const audioStatus = document.getElementById("audioStatus");
			const volumeSlider = document.getElementById("volumeSlider");
			const volumeValue = document.getElementById("volumeValue");

			let audioContext = null;
			let currentVolume = 0.8;
			let isPlaying = false;

			// Initialize Web Audio API
			function initAudioContext() {
				if (!audioContext) {
					audioContext = new (window.AudioContext ||
						window.webkitAudioContext)();
				}
				return audioContext;
			}

			// Volume control
			volumeSlider.addEventListener("input", (e) => {
				currentVolume = e.target.value / 100;
				volumeValue.textContent = e.target.value + "%";
			});

			// Socket connection events
			socket.on("connect", () => {
				console.log("Connected to server");
				connectionStatus.textContent = "‚úì Connected to server";
				connectionStatus.className = "status connected";
			});

			socket.on("disconnect", () => {
				console.log("Disconnected from server");
				connectionStatus.textContent = "‚úó Disconnected from server";
				connectionStatus.className = "status disconnected";
			});

			socket.on("update_requests", (requests) => {
				requestsDiv.innerHTML = "";
				if (requests.length === 0) {
					requestsDiv.innerHTML =
						'<div class="request">No talk requests yet...</div>';
					return;
				}

				requests.forEach((req) => {
					const reqDiv = document.createElement("div");
					reqDiv.className = "request";
					reqDiv.innerHTML = `
						<strong>${req.senderName}</strong>
						${
							req.isTalking
								? '<span class="talking-indicator">üé§ Currently Talking</span>'
								: ""
						}
						<div class="buttons">
							${
								!req.isTalking
									? `
								<button onclick="accept('${req.socketId}')">Accept</button>
								<button class="reject" onclick="reject('${req.socketId}')">Reject</button>
							`
									: `
								<button class="stop" onclick="stop('${req.socketId}')">Stop</button>
							`
							}
						</div>
					`;
					requestsDiv.appendChild(reqDiv);
				});
			});

			socket.on("audio_stream", async (data) => {
				console.log("Received audio from:", data.senderName);
				try {
					await playAudioChunk(data.audio);
				} catch (error) {
					console.error("Error playing audio:", error);
				}
			});

			socket.on("audio_done", () => {
				console.log("Audio stream ended");
				updateAudioStatus("Audio stream ended", false);
			});

			// Play audio chunk using Web Audio API
			async function playAudioChunk(base64Audio) {
				try {
					const audioCtx = initAudioContext();

					// Resume audio context if suspended
					if (audioCtx.state === "suspended") {
						await audioCtx.resume();
					}

					// Convert base64 to ArrayBuffer
					const binaryString = atob(base64Audio);
					const bytes = new Uint8Array(binaryString.length);
					for (let i = 0; i < binaryString.length; i++) {
						bytes[i] = binaryString.charCodeAt(i);
					}

					// Decode audio data
					const audioBuffer = await audioCtx.decodeAudioData(bytes.buffer);

					// Create audio source
					const source = audioCtx.createBufferSource();
					const gainNode = audioCtx.createGain();

					source.buffer = audioBuffer;
					gainNode.gain.value = currentVolume;

					// Connect nodes
					source.connect(gainNode);
					gainNode.connect(audioCtx.destination);

					// Play audio
					source.start();

					updateAudioStatus("üéµ Playing audio...", true);

					// Update status after audio ends
					setTimeout(() => {
						updateAudioStatus("Waiting for audio...", false);
					}, audioBuffer.duration * 1000);
				} catch (error) {
					console.error("Error playing audio:", error);
					updateAudioStatus("Error playing audio", false);
				}
			}

			function updateAudioStatus(message, playing) {
				audioStatus.textContent = message;
				audioStatus.className = playing ? "status playing" : "status";
				isPlaying = playing;
			}

			function accept(socketId) {
				socket.emit("accept_request", { socketId });
			}

			function reject(socketId) {
				socket.emit("reject_request", { socketId });
			}

			function stop(socketId) {
				socket.emit("stop_request", { socketId });
			}

			// Initialize audio context on first user interaction
			document.addEventListener(
				"click",
				() => {
					initAudioContext();
				},
				{ once: true }
			);

			// Initialize status
			updateAudioStatus("Ready to receive audio", false);
		</script>
	</body>
</html>
